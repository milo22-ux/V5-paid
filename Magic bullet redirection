local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local GetFunction = function(Script, Line)
    for _, v in pairs(getgc()) do
        if typeof(v) == "function" and debug.info(v, "sl") then
            local src, lineNum = debug.info(v, "s"), debug.info(v, "l")
            if src:find(Script) and lineNum == Line then
                return v
            end
        end
    end
end

local SetInfraredEnabled = GetFunction("PlayerClient", 588)
local PlayerReg = debug.getupvalue(SetInfraredEnabled, 2)

local domagic = true
local fov = true
local fov_show = true
local fov_size = 150
local snapline = true
local sleep_check = true

local target, spos, cachedtarget

local CircleOutline = Drawing.new("Circle")
CircleOutline.Thickness = 2
CircleOutline.Color = Color3.new(0,0,0)
CircleOutline.Filled = false
CircleOutline.NumSides = 64
CircleOutline.Visible = true

local CircleInline = Drawing.new("Circle")
CircleInline.Thickness = 1
CircleInline.Color = Color3.new(1,1,1)
CircleInline.Filled = false
CircleInline.NumSides = 64
CircleInline.Visible = true

local snaplinedrawing = Drawing.new("Line")
snaplinedrawing.Thickness = 1
snaplinedrawing.Color = Color3.new(1,1,1)
snaplinedrawing.Visible = false

local function update_fov()
    CircleInline.Radius = fov_size
    CircleInline.Visible = fov and fov_show
    CircleOutline.Radius = fov_size
    CircleOutline.Visible = fov and fov_show
end
update_fov()

local function IsSleeping(model)
    if model and model:FindFirstChild("AnimationController") and model.AnimationController:FindFirstChild("Animator") then
        for _, v in pairs(model.AnimationController.Animator:GetPlayingAnimationTracks()) do
            if v.Animation and v.Animation.AnimationId == "rbxassetid://13280887764" then
                return true
            end
        end
    end
    return false
end

local function get_closest_target()
    local closest, spos
    local max_dist = fov_size
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

    for _, player in pairs(PlayerReg) do
        if player and player.model then
            local head = player.model:FindFirstChild("Head")
            if head and (not sleep_check or not IsSleeping(player.model)) then
                local pos, onscreen = Camera:WorldToViewportPoint(head.Position)
                if onscreen then
                    local dist = (Vector2.new(pos.X,pos.Y) - center).Magnitude
                    if dist < max_dist then
                        closest = head
                        spos = Vector2.new(pos.X,pos.Y)
                        max_dist = dist
                    end
                end
            end
        end
    end
    return closest, spos
end

RunService.RenderStepped:Connect(function()
    target, spos = get_closest_target()
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

    if target and spos then
        snaplinedrawing.Visible = snapline
        snaplinedrawing.From = center
        snaplinedrawing.To = spos
    else
        snaplinedrawing.Visible = false
    end

    CircleOutline.Position = center
    CircleInline.Position = center
end)

local function add_magic(obj)
    if not obj then return end
    if not obj:FindFirstChild("whiz") then return end
    if not domagic then return end

    local confirmed = false
    obj:GetPropertyChangedSignal("CFrame"):Connect(function()
        if not confirmed and (Camera.CFrame.Position - obj.CFrame.Position).Magnitude < 1 then
            confirmed = true
        end
        if confirmed and (cachedtarget or target) then
            if not cachedtarget then cachedtarget = target end
            local bulletpos = obj.CFrame.Position
            local primary = cachedtarget.Parent and cachedtarget.Parent.PrimaryPart
            if primary and primary:IsA("BasePart") then
                primary.CFrame = CFrame.new(Vector3.new(bulletpos.X, primary.Position.Y, bulletpos.Z))
            end
        end
    end)

    RunService.Heartbeat:Connect(function()
        if not obj or not obj.Parent then
            cachedtarget = false
        end
    end)
end

if workspace:FindFirstChild("Const") and workspace.Const:FindFirstChild("Ignore") then
    workspace.Const.Ignore.ChildAdded:Connect(add_magic)
end
